package com.opencn.mesh.endpoint;import com.alipay.sofa.rpc.boot.runtime.param.BoltBindingParam;import com.alipay.sofa.runtime.api.annotation.SofaClientFactory;import com.alipay.sofa.runtime.api.client.ReferenceClient;import com.alipay.sofa.runtime.api.client.param.BindingParam;import com.alipay.sofa.runtime.api.client.param.ReferenceParam;import com.opencn.mesh.log.PipelineLogger;import com.opencn.mesh.model.PipelineRequest;import com.opencn.mesh.model.PipelineResponse;import com.opencn.mesh.service.BizCommonService;import org.springframework.web.bind.annotation.*;@RestController("/")public class TrafficEndPoint {    @SofaClientFactory    private ReferenceClient referenceClient;    @PostMapping("/request")    @ResponseBody    public PipelineResponse req(@RequestBody PipelineRequest pipelineRequest) {        try {            BizCommonService proxy = getProxy(pipelineRequest);            PipelineResponse response = proxy.invoke(pipelineRequest);            PipelineLogger.debug("[pipeline] req success with bizIdentify:{} bizKey:{}",                    pipelineRequest.getBizIdentify(), pipelineRequest.getBizKey(), pipelineRequest.getBizData());            return response;        } catch (Exception e) {            PipelineLogger.error("[pipeline] req error with bizIdentify:{} bizKey:{} cause {}",                    pipelineRequest.getBizIdentify(), pipelineRequest.getBizKey(), e.getMessage());            return PipelineResponse.builder().success(false).data("server error").build();        }    }    @PostMapping("/callback/{bizIdentify}/{bizKey}")    @ResponseBody    public PipelineResponse callback(@PathVariable String bizIdentify, @PathVariable String bizKey, @RequestBody Object request) {        try {            BizCommonService proxy = getProxy(bizIdentify);            PipelineResponse response = proxy.callback(bizKey, request);            PipelineLogger.info("[pipeline] callback success with bizIdentify:{} bizKey:{}",                    bizIdentify, bizKey, request);            return response;        } catch (Exception e) {            PipelineLogger.error("[pipeline] callback error with bizIdentify:{} bizKey:{} cause {}",                    bizIdentify, bizKey, e.getMessage());            return PipelineResponse.builder().success(false).data("server error").build();        }    }    private BizCommonService getProxy(PipelineRequest pipelineRequest) {        ReferenceParam<BizCommonService> referenceParam = new ReferenceParam<>();        referenceParam.setInterfaceType(BizCommonService.class);        referenceParam.setUniqueId(pipelineRequest.getBizIdentify());        referenceParam.setJvmFirst(true);        BindingParam boltBindingParam = new BoltBindingParam();        referenceParam.setBindingParam(boltBindingParam);        return referenceClient.reference(referenceParam);    }    private BizCommonService getProxy(String bizIdentify) {        ReferenceParam<BizCommonService> referenceParam = new ReferenceParam<>();        referenceParam.setInterfaceType(BizCommonService.class);        referenceParam.setUniqueId(bizIdentify);        referenceParam.setJvmFirst(true);        BindingParam boltBindingParam = new BoltBindingParam();        referenceParam.setBindingParam(boltBindingParam);        return referenceClient.reference(referenceParam);    }}